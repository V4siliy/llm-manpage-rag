{% extends "base.html" %}

{% block title %}Ask a Question - Man Page RAG{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">
                        <i class="fas fa-question-circle"></i> Ask a Question
                    </h2>
                    <p class="text-muted mb-0">Get answers about Linux commands and system functions using our RAG-powered assistant</p>
                </div>
                <div class="card-body">
                    <form id="askForm">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label for="questionInput" class="form-label">Your Question</label>
                            <textarea 
                                class="form-control" 
                                id="questionInput" 
                                rows="3" 
                                placeholder="Ask anything about Linux commands, system functions, or man pages..."
                                required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" id="askButton">
                            <i class="fas fa-search"></i> Ask Question
                        </button>
                    </form>
                </div>
            </div>

            <!-- Loading Section -->
            <div id="loadingSection" class="card mt-4" style="display: none;">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 id="loadingMessage">Consulting the manual pages...</h5>
                    <p class="text-muted">This may take a few moments...</p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-lightbulb"></i> Answer
                        </h4>
                    </div>
                    <div class="card-body">
                        <div id="answerContent"></div>
                    </div>
                </div>

                <!-- Sources Section -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-book"></i> Sources
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="sourcesContent"></div>
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div id="errorSection" class="alert alert-danger mt-4" style="display: none;">
                <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
                <p id="errorMessage"></p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const askForm = document.getElementById('askForm');
    const questionInput = document.getElementById('questionInput');
    const askButton = document.getElementById('askButton');
    const loadingSection = document.getElementById('loadingSection');
    const loadingMessage = document.getElementById('loadingMessage');
    const resultsSection = document.getElementById('resultsSection');
    const answerContent = document.getElementById('answerContent');
    const sourcesContent = document.getElementById('sourcesContent');
    const errorSection = document.getElementById('errorSection');
    const errorMessage = document.getElementById('errorMessage');

    // Loading messages from Django settings
    const loadingMessages = {{ loading_messages_json|safe }};
    let loadingInterval;

    function startLoadingAnimation() {
        loadingSection.style.display = 'block';
        resultsSection.style.display = 'none';
        errorSection.style.display = 'none';
        
        // Show random message immediately
        loadingMessage.textContent = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
        
        // Change to a new random message every 2 seconds
        loadingInterval = setInterval(() => {
            loadingMessage.textContent = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
        }, 2000);
    }

    function stopLoadingAnimation() {
        if (loadingInterval) {
            clearInterval(loadingInterval);
        }
        loadingSection.style.display = 'none';
    }

    function showError(message) {
        stopLoadingAnimation();
        errorMessage.textContent = message;
        errorSection.style.display = 'block';
        resultsSection.style.display = 'none';
    }

    function showResults(data) {
        stopLoadingAnimation();
        
        // Decode Unicode escape sequences (like \u000A for newlines)
        const decodedAnswer = data.answer.replace(/\\u([0-9a-fA-F]{4})/g, function(match, hex) {
            return String.fromCharCode(parseInt(hex, 16));
        });
        
        // Convert markdown to HTML and sanitize
        const markdownHtml = marked.parse(decodedAnswer);
        const sanitizedHtml = DOMPurify.sanitize(markdownHtml);
        
        // Display answer with markdown converted to HTML
        answerContent.innerHTML = `<div class="answer-text">${sanitizedHtml}</div>`;
        
        // Highlight code blocks with Prism.js
        Prism.highlightAllUnder(answerContent);
        
        // Display sources
        if (data.sources && data.sources.length > 0) {
            let sourcesHtml = '<div class="sources-list">';
            data.sources.forEach((source, index) => {
                const similarity = source.similarity ? ` (${(source.similarity * 100).toFixed(1)}% match)` : '';
                sourcesHtml += `
                    <div class="source-item mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${source.document}</strong> - ${source.title}
                                <br>
                                <small class="text-muted">Section: ${source.section}${similarity}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            sourcesHtml += '</div>';
            sourcesContent.innerHTML = sourcesHtml;
        } else {
            sourcesContent.innerHTML = '<p class="text-muted">No sources found.</p>';
        }
        
        resultsSection.style.display = 'block';
        errorSection.style.display = 'none';
    }

    askForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const question = questionInput.value.trim();
        if (!question) {
            showError('Please enter a question.');
            return;
        }

        askButton.disabled = true;
        askButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        startLoadingAnimation();

        try {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
            
            if (!csrfToken) {
                throw new Error('CSRF token not found');
            }

            const response = await fetch('/search/ask-api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    question: question
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'An error occurred');
            }

            showResults(data);

        } catch (error) {
            showError(error.message);
        } finally {
            askButton.disabled = false;
            askButton.innerHTML = '<i class="fas fa-search"></i> Ask Question';
        }
    });

    // Auto-resize textarea
    questionInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
});
</script>

<style>
.answer-text {
    line-height: 1.6;
    font-size: 1.1rem;
}

/* Code block styling */
.answer-text pre {
    background-color: #2d3748;
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 1rem 0;
    overflow-x: auto;
    border: 1px solid #4a5568;
}

.answer-text code {
    background-color: #f7fafc;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    color: #e53e3e;
    border: 1px solid #e2e8f0;
}

.answer-text pre code {
    background-color: transparent;
    padding: 0;
    border: none;
    color: inherit;
    font-size: inherit;
}

/* Prism.js theme override for better integration */
.answer-text pre[class*="language-"] {
    background-color: #2d3748;
    color: #e2e8f0;
}

/* Inline code styling */
.answer-text p code,
.answer-text li code {
    background-color: #f7fafc;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    color: #e53e3e;
    border: 1px solid #e2e8f0;
}

/* Blockquote styling */
.answer-text blockquote {
    border-left: 4px solid #0d6efd;
    padding-left: 1rem;
    margin: 1rem 0;
    color: #6c757d;
    font-style: italic;
}

/* List styling */
.answer-text ul,
.answer-text ol {
    padding-left: 1.5rem;
}

.answer-text li {
    margin-bottom: 0.5rem;
}

.source-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.source-item:hover {
    background-color: #e9ecef;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

#loadingMessage {
    color: #0d6efd;
    font-weight: 500;
}
</style>
{% endblock %}
